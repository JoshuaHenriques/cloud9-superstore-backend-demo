package org.jayhenri.cloud9.controller.customerRegistration;

import org.jayhenri.cloud9.controller.CustomerRegistrationController;
import org.jayhenri.cloud9.exception.CustomerAlreadyExistsException;
import org.jayhenri.cloud9.exception.InvalidCustomerException;
import org.jayhenri.cloud9.exception.InvalidPostalCodeException;
import org.jayhenri.cloud9.model.*;
import org.jayhenri.cloud9.service.AddressService;
import org.jayhenri.cloud9.service.customer.CustomerService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import java.net.http.HttpHeaders;
import java.util.ArrayList;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.mockito.BDDMockito.given;
import static org.mockito.BDDMockito.then;

/**
 * The type Customer registration uni test.
 */
@ExtendWith(MockitoExtension.class)
public class CustomerRegistrationUniTest {

    @Captor
    private ArgumentCaptor<Customer> captorCustomer;

    @Mock
    private CustomerService customerService;

    @Mock
    private AddressService addressService;

    private CustomerRegistrationController testMe;

    private Customer customer;

    /**
     * Sets up.
     */
    @BeforeEach
    void setUp() {
        customer = new Customer();
        testMe = new CustomerRegistrationController(addressService, customerService);

        ArrayList<Item> items = new ArrayList<>();
        ArrayList<OrderDetails> orderDetails = new ArrayList<>();
        ArrayList<CreditCard> creditCards = new ArrayList<>();

        Item item = new Item(
                "Test Product",
                "Test Description",
                9.99
        );

        items.add(item);

        OrderDetails orderDetails1 = new OrderDetails(
                "PROCESSING",
                "testMe@gmail.com",
                items,
                9.00
        );
        Cart cart = new Cart(
                items,
                "testMe@gmail.com",
                29.23
        );
        CreditCard creditCard = new CreditCard(
                "Ubuntu User",
                "4716902620158281",
                "8281",
                "05/25",
                "8281"
        );

        orderDetails.add(orderDetails1);
        creditCards.add(creditCard);

        customer = new Customer(
                "testMe",
                "TestMe",
                "2934811932",
                "testMe@gmail.com",
                "testMePassword",
                "082395",
                new Address(
                        "Test Me",
                        "29L",
                        "0L",
                        "New York",
                        "T2K9R3",
                        "Province"
                ),
                cart,
                creditCards,
                orderDetails
        );
    }

    /**
     * Register.
     *
     * @throws InvalidPostalCodeException     the invalid postal code exception
     * @throws CustomerAlreadyExistsException the customer already exists exception
     * @throws InvalidCustomerException       the invalid customer exception
     */
    @Test
    void register() throws InvalidPostalCodeException, CustomerAlreadyExistsException, InvalidCustomerException {
        given(customerService.existsByEmail(customer.getEmail())).willReturn(false);
        given(customerService.existsByPhoneNumber(customer.getPhoneNumber())).willReturn(false);
        given(addressService.isValidPostalCode(customer.getAddress().getPostalCode())).willReturn(true);

        ResponseEntity<String> response = testMe.register(customer);

        then(customerService).should().add(captorCustomer.capture());

        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        assertThat(customer).isEqualTo(captorCustomer.getValue());
    }

    /**
     * Register throws invalid postal code exception.
     */
    @Test
    void registerThrowsInvalidPostalCodeException() {
        given(addressService.isValidPostalCode(customer.getAddress().getPostalCode())).willReturn(false);

        assertThrows(InvalidPostalCodeException.class, () -> {
            testMe.register(customer);
        });
    }

    /**
     * Register throws customer already exists exception.
     */
    @Test
    void registerThrowsCustomerAlreadyExistsException() {
        given(customerService.existsByEmail(customer.getEmail())).willReturn(true);

        assertThrows(CustomerAlreadyExistsException.class, () -> {
            testMe.register(customer);
        });
    }
}
